<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞—à–±–æ—Ä–¥ - –ò–ü–†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css?v=22">
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <span class="navbar-brand">üí´ –°–µ–≥–æ–¥–Ω—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –µ—â–µ –æ–¥–Ω–∞ –∫—Ä—É—Ç–∞—è –∑–∞–¥–∞—á–∞</span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/dashboard">–î–∞—à–±–æ—Ä–¥</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">–í—ã—Ö–æ–¥</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 id="pageTitle">–ú–æ–∏ –ò–ü–†</h1>
                <p class="text-muted" id="userInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <button class="btn btn-primary" id="createIdpBtn" style="display: none;">
                + –°–æ–∑–¥–∞—Ç—å –ò–ü–†
            </button>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –ò–ü–† -->
        <div id="idpList" class="row">
            <div class="col-12 text-center py-5">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/app.js?v=37"></script>
    <script>
        console.log('[DASHBOARD] Script started');
        console.log('[DASHBOARD] Checking app.js functions...');
        console.log('[DASHBOARD] apiRequest:', typeof apiRequest);
        console.log('[DASHBOARD] checkAuth:', typeof checkAuth);
        console.log('[DASHBOARD] getToken:', typeof getToken);
        console.log('[DASHBOARD] currentUser:', typeof currentUser);
        
        // currentUser —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω–∞ –≤ app.js

        async function loadDashboard() {
            console.log('[DEBUG] loadDashboard started');
            
            if (!await checkAuth()) {
                console.log('[DEBUG] checkAuth failed');
                return;
            }
            
            console.log('[DEBUG] checkAuth passed');

            try {
                console.log('[DEBUG] Requesting /api/idps/...');
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –ò–ü–† —Å —Ç–∞–π–º–∞—É—Ç–æ–º
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
                
                const idps = await apiRequest('/idps/', { signal: controller.signal });
                clearTimeout(timeoutId);
                
                console.log('[DEBUG] Got IDPs:', idps);
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                let isMentor = false;
                
                if (idps.length > 0) {
                    const firstIdp = idps[0];
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å —á–µ—Ä–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const userStr = localStorage.getItem('currentUser');
                    if (userStr) {
                        currentUser = JSON.parse(userStr);
                        isMentor = currentUser.role === 'mentor';
                    } else {
                        // Fallback: –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ –ò–ü–†
                        isMentor = firstIdp.mentor_id === firstIdp.mentor.id;
                        currentUser = isMentor ? firstIdp.mentor : firstIdp.mentee;
                    }
                    
                    document.getElementById('userInfo').textContent = 
                        `${currentUser.full_name} (${isMentor ? '–ú–µ–Ω—Ç–æ—Ä' : '–ú–µ–Ω—Ç–∏'})`;
                    
                    // –ò–∑–º–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
                    document.getElementById('pageTitle').textContent = 
                        isMentor ? '–°–æ–∑–¥–∞–Ω–Ω—ã–µ –ò–ü–†' : '–ú–æ–π –ò–ü–†';
                    
                    // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –ò–ü–† –¥–ª—è –º–µ–Ω—Ç–æ—Ä–∞
                    if (isMentor) {
                        document.getElementById('createIdpBtn').style.display = 'block';
                        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ò–ü–† –¥–ª—è –º–µ–Ω—Ç–æ—Ä–∞
                        displayIDPs(idps);
                    } else {
                        // –î–ª—è –º–µ–Ω—Ç–∏ - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –∫–∞–Ω–±–∞–Ω –µ–≥–æ –ò–ü–†
                        console.log('[DEBUG] User is mentee, redirecting to kanban');
                        window.location.href = `/kanban/${firstIdp.id}`;
                    }
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –ò–ü–†, –ø–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏–∑ localStorage
                    const userStr = localStorage.getItem('currentUser');
                    if (userStr) {
                        currentUser = JSON.parse(userStr);
                        isMentor = currentUser.role === 'mentor';
                        
                        document.getElementById('userInfo').textContent = 
                            `${currentUser.full_name} (${isMentor ? '–ú–µ–Ω—Ç–æ—Ä' : '–ú–µ–Ω—Ç–∏'})`;
                        
                        // –ò–∑–º–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
                        document.getElementById('pageTitle').textContent = 
                            isMentor ? '–°–æ–∑–¥–∞–Ω–Ω—ã–µ –ò–ü–†' : '–ú–æ–π –ò–ü–†';
                        
                        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –ò–ü–† –¥–ª—è –º–µ–Ω—Ç–æ—Ä–∞
                        if (isMentor) {
                            document.getElementById('createIdpBtn').style.display = 'block';
                        }
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
                        displayIDPs([]);
                    } else {
                        document.getElementById('userInfo').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                        displayIDPs([]);
                    }
                }
            } catch (error) {
                console.error('[ERROR] loadDashboard failed:', error);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                document.getElementById('idpList').innerHTML = `
                    <div class="col-12 text-center py-5">
                        <div class="alert alert-danger">
                            <h5>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h5>
                            <p>${error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ'}</p>
                            <button class="btn btn-primary" onclick="location.reload()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                        </div>
                    </div>
                `;
                
                showError(error);
            }
        }

        function displayIDPs(idps) {
            const container = document.getElementById('idpList');
            
            if (idps.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <p class="text-muted">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ò–ü–†</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = idps.map(idp => `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">${idp.mentee.full_name}</h5>
                            <p class="text-muted mb-2">
                                <small>–ú–µ–Ω—Ç–æ—Ä: ${idp.mentor.full_name}</small>
                            </p>
                            <p class="text-muted mb-3">
                                <small>–°–æ–∑–¥–∞–Ω: ${formatDate(idp.created_at)}</small>
                            </p>
                            <div class="mb-3">
                                <span class="badge bg-${idp.status === 'active' ? 'success' : 'secondary'}">
                                    ${idp.status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ó–∞–≤–µ—Ä—à–µ–Ω'}
                                </span>
                                <span class="badge bg-info">
                                    ${idp.tasks.length} –∑–∞–¥–∞—á
                                </span>
                            </div>
                            <a href="/kanban/${idp.id}" class="btn btn-primary btn-sm w-100">
                                –û—Ç–∫—Ä—ã—Ç—å –¥–æ—Å–∫—É
                            </a>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ò–ü–† (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
        const createBtn = document.getElementById('createIdpBtn');
        if (createBtn) {
            createBtn.addEventListener('click', () => {
                window.location.href = '/create-idp';
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        console.log('[DASHBOARD] Starting initialization...');
        console.log('[DASHBOARD] Token:', localStorage.getItem('authToken') ? 'EXISTS' : 'NO TOKEN');
        console.log('[DASHBOARD] User:', localStorage.getItem('currentUser') ? 'EXISTS' : 'NO USER');
        
        // –£–±–µ–¥–∏–º—Å—è —á—Ç–æ DOM –≥–æ—Ç–æ–≤
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('[DASHBOARD] DOM Ready - calling loadDashboard');
                loadDashboard();
            });
        } else {
            console.log('[DASHBOARD] DOM Already Ready - calling loadDashboard');
            loadDashboard();
        }
    </script>
</body>
</html>


