<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–Ω–±–∞–Ω –¥–æ—Å–∫–∞ - –ò–ü–†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css?v=22">
    <style>
        .task-card {
            cursor: grab;
            user-select: none;
        }
        .task-card:active {
            cursor: grabbing;
        }
        .task-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .kanban-column {
            min-height: 300px;
        }
        .kanban-column.drag-over {
            background-color: #e8e8e8;
            border: 2px dashed var(--primary-color);
        }
        .tasks-container {
            min-height: 250px;
            pointer-events: none; /* –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º drop –Ω–∞ –∫–æ–ª–æ–Ω–∫–µ */
        }
        .tasks-container .task-card {
            pointer-events: auto; /* –ù–æ –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã */
        }
        .comment-item {
            padding: 12px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid var(--secondary-color);
        }
        .comment-author {
            font-weight: 600;
            color: var(--dark-color);
        }
        .comment-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-right: 8px;
        }
        .comment-actions {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .comment-actions .btn-link {
            text-decoration: none;
            font-size: 1.1rem;
            line-height: 1;
            transition: transform 0.2s;
        }
        .comment-actions .btn-link:hover {
            transform: scale(1.2);
        }
        .comment-item textarea {
            font-size: 0.9rem;
        }
        
        /* –ö—Ä–∞—Å–∏–≤—ã–π —Å—Ç–∏–ª—å –¥–ª—è select –Ω–∞–≤—ã–∫–∞ */
        #taskSkillSelect {
            font-size: 0.9rem;
            overflow-y: auto;
            cursor: pointer;
        }
        #taskSkillSelect optgroup {
            font-weight: 700;
            font-style: normal;
            color: #212529;
            background-color: #e9ecef;
            padding: 6px 8px;
            margin-top: 4px;
            font-size: 0.85rem;
            text-transform: none;
        }
        #taskSkillSelect option {
            padding: 6px 12px;
            font-size: 0.9rem;
            background-color: white;
            color: #495057;
        }
        #taskSkillSelect option:hover,
        #taskSkillSelect option:focus {
            background-color: #e7f1ff;
        }
        #taskSkillSearch {
            font-size: 0.9rem;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —á–µ–∫–ª–∏—Å—Ç–∞ */
        .form-check-input {
            cursor: pointer;
            width: 1.2em;
            height: 1.2em;
        }
        .form-check-label {
            cursor: pointer;
            font-size: 0.95rem;
            user-select: none;
        }
        .form-check-label.text-decoration-line-through {
            opacity: 0.6;
        }
        .linked-skill-badge {
            display: inline-block;
            padding: 2px 6px;
            background-color: #f5f5f5;
            font-size: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.85rem;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <span class="navbar-brand">üí´ –°–µ–≥–æ–¥–Ω—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –µ—â–µ –æ–¥–Ω–∞ –∫—Ä—É—Ç–∞—è –∑–∞–¥–∞—á–∞</span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">–î–∞—à–±–æ—Ä–¥</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">–í—ã—Ö–æ–¥</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 id="idpTitle">–ö–∞–Ω–±–∞–Ω –¥–æ—Å–∫–∞</h1>
                <p class="text-muted" id="idpInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <div>
                <button class="btn btn-primary" id="addTaskBtn" data-bs-toggle="modal" data-bs-target="#createTaskModal" onclick="prepareCreateTaskModal()" style="display: none;">
                    + –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É
                </button>
                <button class="btn btn-secondary" id="closeIdpBtn" onclick="closeIDP()" style="display: none;">
                    –ó–∞–∫—Ä—ã—Ç—å –ò–ü–†
                </button>
            </div>
        </div>

        <!-- –ö–∞–Ω–±–∞–Ω –¥–æ—Å–∫–∞ -->
        <div class="kanban-board" id="kanbanBoard">
            <!-- –ö–æ–ª–æ–Ω–∫–∞: –ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é -->
            <div class="kanban-column todo" data-status="todo">
                <div class="kanban-column-header">
                    –ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é
                    <span class="badge bg-secondary" id="todoCount">0</span>
                </div>
                <div id="todoTasks" class="tasks-container"></div>
            </div>

            <!-- –ö–æ–ª–æ–Ω–∫–∞: –í —Ä–∞–±–æ—Ç–µ -->
            <div class="kanban-column in-progress" data-status="in_progress">
                <div class="kanban-column-header">
                    –í —Ä–∞–±–æ—Ç–µ
                    <span class="badge bg-warning" id="inProgressCount">0</span>
                </div>
                <div id="inProgressTasks" class="tasks-container"></div>
            </div>

            <!-- –ö–æ–ª–æ–Ω–∫–∞: –ì–æ—Ç–æ–≤–æ -->
            <div class="kanban-column done" data-status="done">
                <div class="kanban-column-header">
                    –ì–æ—Ç–æ–≤–æ
                    <span class="badge bg-success" id="doneCount">0</span>
                </div>
                <div id="doneTasks" class="tasks-container"></div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ò–ü–† -->
        <div class="row mt-5 mb-4 justify-content-center">
            <!-- –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title text-center mb-3">–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</h6>
                        <canvas id="overallProgressChart" style="max-height: 200px;"></canvas>
                        <div class="text-center mt-2" style="font-size: 0.85rem;">
                            <span class="me-2"><span style="display: inline-block; width: 10px; height: 10px; background: #90EE90; border-radius: 2px;"></span> –í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                            <span class="me-2"><span style="display: inline-block; width: 10px; height: 10px; background: #FFD700; border-radius: 2px;"></span> –í —Ä–∞–±–æ—Ç–µ</span>
                            <span><span style="display: inline-block; width: 10px; height: 10px; background: #87CEEB; border-radius: 2px;"></span> –û—Å—Ç–∞–ª–æ—Å—å</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ù–∞–≤—ã–∫–∏ -->
            <div class="col-md-5">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title mb-3">–¢–∞–∫–∂–µ –ø—Ä–æ–∫–∞—á–∏–≤–∞—é—Ç—Å—è –Ω–∞–≤—ã–∫–∏</h6>
                        <div id="skillsList" class="skills-badges-container">
                            <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –±–µ–π–¥–∂–∏ —Å –Ω–∞–≤—ã–∫–∞–º–∏ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
    <div class="modal fade" id="createTaskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createTaskForm">
                        <div class="mb-3">
                            <label for="taskTitle" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ *</label>
                            <input type="text" class="form-control" id="taskTitle" required 
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏">
                        </div>
                        <div class="mb-3">
                            <label for="taskDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea class="form-control" id="taskDescription" rows="3"
                                      placeholder="–û–ø–∏—à–∏—Ç–µ —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="taskGoal" class="form-label">–ü–ª–∞–Ω–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</label>
                            <textarea class="form-control" id="taskGoal" rows="2"
                                      placeholder="–ö–∞–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–∂–∏–¥–∞–µ—Ç—Å—è..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="taskSkillSearch" class="form-label">–ù–∞–≤—ã–∫ *</label>
                            <input type="text" class="form-control mb-2" id="taskSkillSearch" 
                                   placeholder="üîç –ü–æ–∏—Å–∫ –Ω–∞–≤—ã–∫–∞..." 
                                   onkeyup="filterSkills()">
                            <select class="form-select" id="taskSkillSelect" required size="8" 
                                    style="min-height: 200px; max-height: 300px;">
                                <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–≤—ã–∫–æ–≤...</option>
                                <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </select>
                            <small class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–≤—ã–∫ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫</small>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="taskPriority" class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                                <select class="form-select" id="taskPriority">
                                    <option value="low">–ù–∏–∑–∫–∏–π</option>
                                    <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option>
                                    <option value="high">–í—ã—Å–æ–∫–∏–π</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="taskDeadline" class="form-label">–°—Ä–æ–∫</label>
                                <input type="date" class="form-control" id="taskDeadline">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="createTask()">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–¥–∞—á–∏ -->
    <div class="modal fade" id="viewTaskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewTaskTitle">–ó–∞–¥–∞—á–∞</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="viewTaskBody"></div>
                    
                    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
                    <hr>
                    <h6>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h6>
                    <div id="commentsContainer"></div>
                    
                    <!-- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
                    <div class="mt-3">
                        <textarea class="form-control" id="newComment" rows="2" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." onkeydown="handleCommentKeydown(event)"></textarea>
                        <button class="btn btn-sm btn-primary mt-2" onclick="addComment()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="/static/app.js?v=37"></script>
    <script>
        const idpId = {{ idp_id }};
        let currentTaskId = null;
        let tasks = [];
        let isMentor = false;

        async function loadKanban() {
            if (!await checkAuth()) return;

            try {
                // –ó–∞–≥—Ä—É–∑–∫–∞ –ò–ü–†
                const idp = await apiRequest(`/idps/${idpId}`);
                document.getElementById('idpTitle').textContent = `–ò–ü–†: ${idp.mentee.full_name}`;
                document.getElementById('idpInfo').textContent = 
                    `–ú–µ–Ω—Ç–æ—Ä: ${idp.mentor.full_name} | –°–æ–∑–¥–∞–Ω: ${formatDate(idp.created_at)}`;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å
                const currentUser = getUser();
                isMentor = currentUser && idp.mentor_id === currentUser.id;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω—Ç–æ—Ä–∞
                if (isMentor) {
                    document.getElementById('addTaskBtn').style.display = 'inline-block';
                    document.getElementById('closeIdpBtn').style.display = 'inline-block';
                }

                // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á
                tasks = await apiRequest(`/tasks/idp/${idpId}`);
                displayTasks(tasks);
                
                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                renderStatistics(tasks);
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è drag & drop
                initDragAndDrop();
            } catch (error) {
                showError(error);
            }
        }

        function displayTasks(tasks) {
            const todoContainer = document.getElementById('todoTasks');
            const inProgressContainer = document.getElementById('inProgressTasks');
            const doneContainer = document.getElementById('doneTasks');

            // –û—á–∏—Å—Ç–∫–∞
            todoContainer.innerHTML = '';
            inProgressContainer.innerHTML = '';
            doneContainer.innerHTML = '';

            // –°—á–µ—Ç—á–∏–∫–∏
            let todoCount = 0, inProgressCount = 0, doneCount = 0;

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º TODO –∑–∞–¥–∞—á–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
            const priorityOrder = {'high': 0, 'medium': 1, 'low': 2};
            const todoTasks = tasks.filter(t => t.status === 'todo').sort((a, b) => {
                const aPriority = priorityOrder[a.priority] ?? 3;
                const bPriority = priorityOrder[b.priority] ?? 3;
                if (aPriority !== bPriority) {
                    return aPriority - bPriority;
                }
                return new Date(a.created_at) - new Date(b.created_at);
            });

            // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ –æ—Å—Ç–∞—é—Ç—Å—è –≤ –ø–æ—Ä—è–¥–∫–µ –ø–æ–ª—É—á–µ–Ω–∏—è (–ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è)
            const inProgressTasks = tasks.filter(t => t.status === 'in_progress');
            const doneTasks = tasks.filter(t => t.status === 'done');

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º TODO –∑–∞–¥–∞—á–∏ (—Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É)
            todoTasks.forEach(task => {
                const taskCard = createTaskCard(task);
                todoContainer.appendChild(taskCard);
                todoCount++;
            });

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º IN_PROGRESS –∑–∞–¥–∞—á–∏ (–±–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É)
            inProgressTasks.forEach(task => {
                const taskCard = createTaskCard(task);
                inProgressContainer.appendChild(taskCard);
                inProgressCount++;
            });

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º DONE –∑–∞–¥–∞—á–∏ (–±–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É)
            doneTasks.forEach(task => {
                const taskCard = createTaskCard(task);
                doneContainer.appendChild(taskCard);
                doneCount++;
            });

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤
            document.getElementById('todoCount').textContent = todoCount;
            document.getElementById('inProgressCount').textContent = inProgressCount;
            document.getElementById('doneCount').textContent = doneCount;
            
            // –í–ê–ñ–ù–û: –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º drag & drop –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            initDragAndDrop();
        }

        function createTaskCard(task) {
            const priorityClass = task.priority ? `priority-${task.priority}` : '';
            const card = document.createElement('div');
            card.className = `task-card ${priorityClass}`;
            card.draggable = true;
            card.dataset.taskId = task.id;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞, –Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º
            let isDragging = false;
            card.addEventListener('mousedown', () => {
                isDragging = false;
            });
            card.addEventListener('dragstart', () => {
                isDragging = true;
            });
            card.addEventListener('click', (e) => {
                if (!isDragging) {
                    viewTask(task.id);
                }
                isDragging = false;
            });
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –Ω–∞–≤—ã–∫–∏
            let skillsHtml = '';
            if (task.linked_skills && task.linked_skills.skill) {
                skillsHtml = `<div class="mt-2">
                    <span class="linked-skill-badge">${task.linked_skills.skill}</span>
                    ${task.linked_skills.level ? `<span class="linked-skill-badge">–£—Ä–æ–≤–µ–Ω—å ${task.linked_skills.level}</span>` : ''}
                </div>`;
            }
            
            card.innerHTML = `
                <div class="task-title">${task.title}</div>
                ${skillsHtml}
                <div class="task-meta mt-2">
                    <span class="badge bg-${getPriorityColor(task.priority)}">
                        ${getPriorityText(task.priority)}
                    </span>
                    ${task.deadline ? `<small>–°—Ä–æ–∫: ${formatDate(task.deadline)}</small>` : ''}
                </div>
            `;
            
            return card;
        }

        function getPriorityColor(priority) {
            const colors = { high: 'danger', medium: 'warning', low: 'success' };
            return colors[priority] || 'secondary';
        }

        function getPriorityText(priority) {
            const texts = { high: '–í—ã—Å–æ–∫–∏–π', medium: '–°—Ä–µ–¥–Ω–∏–π', low: '–ù–∏–∑–∫–∏–π' };
            return texts[priority] || '–ù–µ —É–∫–∞–∑–∞–Ω';
        }

        // Drag & Drop
        function initDragAndDrop() {
            const taskCards = document.querySelectorAll('.task-card');
            const kanbanColumns = document.querySelectorAll('.kanban-column');

            console.log('[DEBUG] Initializing drag & drop');
            console.log('[DEBUG] Task cards found:', taskCards.length);
            console.log('[DEBUG] Kanban columns found:', kanbanColumns.length);

            taskCards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });

            kanbanColumns.forEach(column => {
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
                column.removeEventListener('dragover', handleDragOver);
                column.removeEventListener('drop', handleDrop);
                column.removeEventListener('dragleave', handleDragLeave);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('drop', handleDrop);
                column.addEventListener('dragleave', handleDragLeave);
                
                console.log('[DEBUG] Added listeners to column:', column.dataset.status);
            });
            
            console.log('[DEBUG] Drag & drop initialized');
        }

        let draggedTask = null;
        let draggedTaskOriginalStatus = null;

        function handleDragStart(e) {
            draggedTask = this;
            draggedTaskOriginalStatus = this.closest('.kanban-column')?.dataset.status;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            console.log('[DEBUG] Drag started, original status:', draggedTaskOriginalStatus);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.kanban-column').forEach(col => {
                col.classList.remove('drag-over');
            });
            draggedTaskOriginalStatus = null;
            console.log('[DEBUG] Drag ended');
        }

        function handleDragOver(e) {
            e.preventDefault(); // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã drop!
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'move';
            
            // this —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è .kanban-column
            this.classList.add('drag-over');
            
            return false;
        }

        function handleDragLeave(e) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∏–¥–∞–µ–º –∫–æ–ª–æ–Ω–∫—É, –∞ –Ω–µ –ø–µ—Ä–µ–º–µ—â–∞–µ–º—Å—è –º–µ–∂–¥—É –¥–æ—á–µ—Ä–Ω–∏–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏
            if (e.target === this) {
                this.classList.remove('drag-over');
            }
        }

        async function handleDrop(e) {
            console.log('[DEBUG] Drop event fired!');
            
            e.preventDefault();
            e.stopPropagation();

            // this —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è .kanban-column
            const column = this;
            column.classList.remove('drag-over');

            console.log('[DEBUG] Column element:', column);
            console.log('[DEBUG] Column status:', column.dataset.status);

            if (draggedTask) {
                const taskId = parseInt(draggedTask.dataset.taskId);
                const oldStatus = draggedTaskOriginalStatus;
                const newStatus = column.dataset.status;
                
                console.log('[DEBUG] Dropping task:', taskId);
                console.log('[DEBUG] Old status:', oldStatus);
                console.log('[DEBUG] New status:', newStatus);
                
                // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
                if (oldStatus === newStatus) {
                    console.log('[DEBUG] Status unchanged, skipping update');
                    return false;
                }
                
                // –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å - –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                try {
                    console.log('[DEBUG] Sending PATCH request to /tasks/' + taskId);
                    const response = await apiRequest(`/tasks/${taskId}`, {
                        method: 'PATCH',
                        body: JSON.stringify({ status: newStatus })
                    });
                    
                    console.log('[DEBUG] Update successful! Response:', response);
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å–∫—É
                    await loadKanban();
                } catch (error) {
                    console.error('[ERROR] Failed to update task:', error);
                    showError(error);
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –Ω–∞ –º–µ—Å—Ç–æ
                    await loadKanban();
                }
            }
            
            return false;
        }

        let allSkillsCache = null;

        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
        async function prepareCreateTaskModal() {
            const selectElement = document.getElementById('taskSkillSelect');
            const searchInput = document.getElementById('taskSkillSearch');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∏—Å–∫
            searchInput.value = '';
            
            try {
                // –ï—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à
                if (allSkillsCache) {
                    fillSkillsSelect(allSkillsCache);
                    filterSkills(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
                    return;
                }
                
                selectElement.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–≤—ã–∫–æ–≤...</option>';
                selectElement.disabled = true;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                const categories = await apiRequest('/templates/categories');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–≤—ã–∫–∏ –∏–∑ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                const allSkills = new Set();
                const skillsDetails = {};
                
                for (const cat of categories) {
                    const templates = await apiRequest(`/templates/by-category/${encodeURIComponent(cat.category)}`);
                    
                    templates.forEach(t => {
                        const skillName = t.skill_name;
                        allSkills.add(skillName);
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞–≤—ã–∫–µ
                        if (!skillsDetails[skillName]) {
                            skillsDetails[skillName] = {
                                skill: skillName,
                                category: t.category
                            };
                        }
                    });
                }
                
                allSkillsCache = { 
                    skills: Array.from(allSkills).sort(), 
                    details: skillsDetails 
                };
                
                fillSkillsSelect(allSkillsCache);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–≤—ã–∫–æ–≤:', error);
                selectElement.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–≤—ã–∫–æ–≤</option>';
                showError(error);
            }
        }
        
        function fillSkillsSelect(cache) {
            const selectElement = document.getElementById('taskSkillSelect');
            
            selectElement.innerHTML = '';
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –Ω–∞–≤—ã–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            const skillsByCategory = {};
            
            cache.skills.forEach(skill => {
                const category = cache.details[skill]?.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
                if (!skillsByCategory[category]) {
                    skillsByCategory[category] = [];
                }
                skillsByCategory[category].push(skill);
            });
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º optgroup –¥–ª—è –∫–∞–∂–¥–æ–π
            Object.keys(skillsByCategory).sort().forEach(category => {
                const optgroup = document.createElement('optgroup');
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—É–±–∏—Ä–∞–µ–º –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è)
                const formattedCategory = category.replace(/_/g, ' ');
                optgroup.label = formattedCategory;
                optgroup.dataset.category = category;
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞–≤—ã–∫–∏ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                skillsByCategory[category].sort().forEach(skill => {
                    const option = document.createElement('option');
                    option.value = skill;
                    option.textContent = skill;
                    option.dataset.category = category;
                    option.dataset.skillName = skill.toLowerCase();
                    optgroup.appendChild(option);
                });
                
                selectElement.appendChild(optgroup);
            });
            
            selectElement.disabled = false;
        }
        
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞–≤—ã–∫–æ–≤ –ø–æ –ø–æ–∏—Å–∫—É
        function filterSkills() {
            const searchQuery = document.getElementById('taskSkillSearch').value.toLowerCase();
            const selectElement = document.getElementById('taskSkillSelect');
            const optgroups = selectElement.querySelectorAll('optgroup');
            
            if (!searchQuery) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ
                optgroups.forEach(optgroup => {
                    optgroup.style.display = '';
                    const options = optgroup.querySelectorAll('option');
                    options.forEach(opt => opt.style.display = '');
                });
                return;
            }
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º
            optgroups.forEach(optgroup => {
                const options = optgroup.querySelectorAll('option');
                let hasVisibleOptions = false;
                
                options.forEach(opt => {
                    const skillName = opt.dataset.skillName || opt.textContent.toLowerCase();
                    if (skillName.includes(searchQuery)) {
                        opt.style.display = '';
                        hasVisibleOptions = true;
                    } else {
                        opt.style.display = 'none';
                    }
                });
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –µ—Å–ª–∏ –≤ –Ω–µ–π –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –Ω–∞–≤—ã–∫–æ–≤
                optgroup.style.display = hasVisibleOptions ? '' : 'none';
            });
        }

        async function createTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const goal = document.getElementById('taskGoal').value.trim();
            const skillName = document.getElementById('taskSkillSelect').value;
            const priority = document.getElementById('taskPriority').value;
            const deadline = document.getElementById('taskDeadline').value;

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!title) {
                showError({ message: '–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ' });
                return;
            }
            
            if (!skillName) {
                showError({ message: '–ù–∞–≤—ã–∫ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏' });
                return;
            }

            try {
                // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                let fullDescription = '';
                
                if (description) {
                    fullDescription += description;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–∞–Ω–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                if (goal) {
                    fullDescription += fullDescription ? `\n\n–ü–ª–∞–Ω–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:\n${goal}` : `–ü–ª–∞–Ω–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:\n${goal}`;
                }

                // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç linked_skills
                const linkedSkills = {
                    skill: skillName,
                    category: allSkillsCache?.details[skillName]?.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏',
                    level: null
                };

                await apiRequest('/tasks/', {
                    method: 'POST',
                    body: JSON.stringify({
                        idp_id: idpId,
                        title: title,
                        description: fullDescription,
                        priority,
                        deadline: deadline || null,
                        status: 'todo',
                        linked_skills: linkedSkills
                    })
                });

                bootstrap.Modal.getInstance(document.getElementById('createTaskModal')).hide();
                document.getElementById('createTaskForm').reset();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º select –∏ –ø–æ–∏—Å–∫
                document.getElementById('taskSkillSelect').value = '';
                document.getElementById('taskSkillSearch').value = '';
                filterSkills(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
                
                showSuccess('–ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞');
                loadKanban();
            } catch (error) {
                showError(error);
            }
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ –æ–ø–∏—Å–∞–Ω–∏—è —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏
        function parseDescriptionWithChecklists(description, checklistState) {
            if (!description) return '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è';
            
            const lines = description.split('\n');
            let html = '';
            let itemIndex = 0;
            
            lines.forEach(line => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç—Ä–æ–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–º —Å–ø–∏—Å–∫–∞
                const listMatch = line.match(/^[\s]*([-‚Ä¢*])\s+(.+)$/);
                
                if (listMatch) {
                    const itemText = listMatch[2];
                    const isChecked = checklistState && checklistState[itemIndex] === true;
                    
                    html += `
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" 
                                   id="checklist-${itemIndex}" 
                                   data-index="${itemIndex}"
                                   ${isChecked ? 'checked' : ''}
                                   onchange="toggleChecklistItem(${itemIndex})">
                            <label class="form-check-label ${isChecked ? 'text-decoration-line-through text-muted' : ''}" 
                                   for="checklist-${itemIndex}" 
                                   id="checklist-label-${itemIndex}">
                                ${itemText}
                            </label>
                        </div>
                    `;
                    itemIndex++;
                } else {
                    // –û–±—ã—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ - –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç
                    if (line.trim()) {
                        html += `<p class="mb-2">${line}</p>`;
                    } else {
                        html += '<br>';
                    }
                }
            });
            
            return html;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞
        async function toggleChecklistItem(index) {
            const task = tasks.find(t => t.id === currentTaskId);
            if (!task) return;
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ –∑–∞–¥–∞—á–∏
            const checklistState = task.checklist_state || {};
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            const checkbox = document.getElementById(`checklist-${index}`);
            const label = document.getElementById(`checklist-label-${index}`);
            
            checklistState[index] = checkbox.checked;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –º–µ—Ç–∫–∏
            if (checkbox.checked) {
                label.classList.add('text-decoration-line-through', 'text-muted');
            } else {
                label.classList.remove('text-decoration-line-through', 'text-muted');
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            try {
                await apiRequest(`/tasks/${currentTaskId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ checklist_state: checklistState })
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –∑–∞–¥–∞—á–∏
                task.checklist_state = checklistState;
                
                console.log('[CHECKLIST] –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:', checklistState);
            } catch (error) {
                console.error('[CHECKLIST] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —á–µ–∫–±–æ–∫—Å
                checkbox.checked = !checkbox.checked;
                if (checkbox.checked) {
                    label.classList.add('text-decoration-line-through', 'text-muted');
                } else {
                    label.classList.remove('text-decoration-line-through', 'text-muted');
                }
                showError(error);
            }
        }

        async function viewTask(taskId) {
            currentTaskId = taskId;
            const task = tasks.find(t => t.id === taskId);
            
            document.getElementById('viewTaskTitle').textContent = task.title;
            
            // –ü–∞—Ä—Å–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏ (—Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ –ë–î)
            const formattedDesc = parseDescriptionWithChecklists(task.description, task.checklist_state);
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–∞–≤—ã–∫–∏
            let skillsHtml = '';
            if (task.linked_skills && task.linked_skills.skill) {
                skillsHtml = `
                    <div class="mb-3">
                        <h6>–°–≤—è–∑–∞–Ω–Ω—ã–µ –Ω–∞–≤—ã–∫–∏:</h6>
                        <span class="linked-skill-badge">${task.linked_skills.skill}</span>
                        ${task.linked_skills.level ? `<span class="linked-skill-badge">–£—Ä–æ–≤–µ–Ω—å ${task.linked_skills.level}</span>` : ''}
                        ${task.linked_skills.category ? `<br><small class="text-muted">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${task.linked_skills.category}</small>` : ''}
                    </div>
                `;
            }
            
            document.getElementById('viewTaskBody').innerHTML = `
                <div class="mb-3">
                    <h6>–û–ø–∏—Å–∞–Ω–∏–µ:</h6>
                    <div>${formattedDesc}</div>
                </div>
                <div class="mb-3">
                    <h6>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</h6>
                    <span class="badge bg-${getPriorityColor(task.priority)}">
                        ${getPriorityText(task.priority)}
                    </span>
                </div>
                ${task.deadline ? `
                <div class="mb-3">
                    <h6>–°—Ä–æ–∫:</h6>
                    <p>${formatDate(task.deadline)}</p>
                </div>
                ` : ''}
                ${skillsHtml}
            `;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            await loadComments(taskId);

            new bootstrap.Modal(document.getElementById('viewTaskModal')).show();
        }

        async function loadComments(taskId) {
            try {
                const comments = await apiRequest(`/comments/task/${taskId}`);
                const container = document.getElementById('commentsContainer');
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const currentUser = getUser();
                
                if (comments.length === 0) {
                    container.innerHTML = '<p class="text-muted">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                } else {
                    container.innerHTML = comments.map(c => {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∞
                        const isAuthor = currentUser && c.user_id === currentUser.id;
                        const viewActions = isAuthor ? `
                            <div class="comment-actions" id="comment-actions-view-${c.id}">
                                <button class="btn btn-sm btn-link text-secondary p-0 me-2" onclick="editComment(${c.id}, '${c.comment.replace(/'/g, "\\'")}');" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn btn-sm btn-link text-danger p-0" onclick="deleteComment(${c.id})" title="–£–¥–∞–ª–∏—Ç—å">
                                    üóëÔ∏è
                                </button>
                            </div>
                        ` : '';
                        const editActions = isAuthor ? `
                            <div class="comment-actions d-none" id="comment-actions-edit-${c.id}">
                                <button class="btn btn-sm btn-link text-success p-0 me-2" onclick="saveEditComment(${c.id})" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å (Enter)">
                                    ‚úÖ
                                </button>
                                <button class="btn btn-sm btn-link text-secondary p-0" onclick="cancelEditComment(${c.id})" title="–û—Ç–º–µ–Ω–∞ (Esc)">
                                    ‚ùå
                                </button>
                            </div>
                        ` : '';
                        
                        return `
                            <div class="comment-item" id="comment-${c.id}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="comment-author">${c.user_name}</span>
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="comment-time">${formatDate(c.created_at)}</span>
                                                ${viewActions}
                                                ${editActions}
                                            </div>
                                        </div>
                                        <p class="mb-0 mt-1" id="comment-text-${c.id}">${c.comment}</p>
                                        <textarea class="form-control mt-1 d-none" id="comment-edit-${c.id}" rows="2" onkeydown="handleEditCommentKeydown(event, ${c.id})">${c.comment}</textarea>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:', error);
            }
        }
        
        let editingCommentId = null;

        function editComment(commentId, commentText) {
            // –ï—Å–ª–∏ —É–∂–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –¥—Ä—É–≥–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π - –æ—Ç–º–µ–Ω—è–µ–º
            if (editingCommentId && editingCommentId !== commentId) {
                cancelEditComment(editingCommentId);
            }
            
            editingCommentId = commentId;
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º textarea
            document.getElementById(`comment-text-${commentId}`).classList.add('d-none');
            document.getElementById(`comment-edit-${commentId}`).classList.remove('d-none');
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
            const viewActions = document.getElementById(`comment-actions-view-${commentId}`);
            const editActions = document.getElementById(`comment-actions-edit-${commentId}`);
            if (viewActions) viewActions.classList.add('d-none');
            if (editActions) editActions.classList.remove('d-none');
            
            // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ textarea
            document.getElementById(`comment-edit-${commentId}`).focus();
        }

        function cancelEditComment(commentId) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç, —Å–∫—Ä—ã–≤–∞–µ–º textarea
            document.getElementById(`comment-text-${commentId}`).classList.remove('d-none');
            document.getElementById(`comment-edit-${commentId}`).classList.add('d-none');
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ
            const viewActions = document.getElementById(`comment-actions-view-${commentId}`);
            const editActions = document.getElementById(`comment-actions-edit-${commentId}`);
            if (viewActions) viewActions.classList.remove('d-none');
            if (editActions) editActions.classList.add('d-none');
            
            editingCommentId = null;
        }

        async function saveEditComment(commentId) {
            const newText = document.getElementById(`comment-edit-${commentId}`).value.trim();
            
            if (!newText) {
                showError({ message: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º' });
                return;
            }
            
            try {
                await apiRequest(`/comments/${commentId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ comment: newText })
                });
                
                editingCommentId = null;
                await loadComments(currentTaskId);
                showSuccess('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω');
            } catch (error) {
                showError(error);
            }
        }

        async function deleteComment(commentId) {
            const confirmed = await showConfirm(
                '–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π',
                '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?',
                {
                    confirmText: '–î–∞, —É–¥–∞–ª–∏—Ç—å',
                    cancelText: '–û—Ç–º–µ–Ω–∞',
                    confirmClass: 'btn-danger'
                }
            );
            
            if (!confirmed) return;
            
            try {
                await apiRequest(`/comments/${commentId}`, {
                    method: 'DELETE'
                });
                
                await loadComments(currentTaskId);
                showSuccess('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–¥–∞–ª–µ–Ω');
            } catch (error) {
                showError(error);
            }
        }

        function handleCommentKeydown(event) {
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter (–±–µ–∑ Shift)
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                addComment();
            }
        }

        function handleEditCommentKeydown(event, commentId) {
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ Enter (–±–µ–∑ Shift)
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                saveEditComment(commentId);
            }
            // –û—Ç–º–µ–Ω–∞ –ø–æ Escape
            if (event.key === 'Escape') {
                event.preventDefault();
                cancelEditComment(commentId);
            }
        }

        async function addComment() {
            const commentText = document.getElementById('newComment').value.trim();
            if (!commentText) return;

            try {
                await apiRequest('/comments/', {
                    method: 'POST',
                    body: JSON.stringify({
                        task_id: currentTaskId,
                        comment: commentText
                    })
                });

                document.getElementById('newComment').value = '';
                await loadComments(currentTaskId);
            } catch (error) {
                showError(error);
            }
        }

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        let overallChart = null;

        function renderStatistics(tasks) {
            // –ü–æ–¥—Å—á–µ—Ç –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
            const done = tasks.filter(t => t.status === 'done').length;
            const inProgress = tasks.filter(t => t.status === 'in_progress').length;
            const todo = tasks.filter(t => t.status === 'todo').length;

            // –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å (–∫—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞)
            const overallCtx = document.getElementById('overallProgressChart');
            if (overallChart) overallChart.destroy();
            
            overallChart = new Chart(overallCtx, {
                type: 'doughnut',
                data: {
                    labels: ['–í—ã–ø–æ–ª–Ω–µ–Ω–æ', '–í —Ä–∞–±–æ—Ç–µ', '–û—Å—Ç–∞–ª–æ—Å—å'],
                    datasets: [{
                        data: [done, inProgress, todo],
                        backgroundColor: ['#90EE90', '#FFD700', '#87CEEB'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = done + inProgress + todo;
                                    const percentage = total > 0 ? Math.round((context.parsed / total) * 100) : 0;
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // –°–ø–∏—Å–æ–∫ –Ω–∞–≤—ã–∫–æ–≤
            const skillsSet = new Set();
            tasks.forEach(task => {
                if (task.linked_skills?.skill) {
                    skillsSet.add(task.linked_skills.skill);
                }
            });

            const skillsListContainer = document.getElementById('skillsList');
            if (skillsSet.size === 0) {
                skillsListContainer.innerHTML = '<p class="text-muted">–ù–∞–≤—ã–∫–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã</p>';
            } else {
                const skillsArray = Array.from(skillsSet);
                skillsListContainer.innerHTML = skillsArray.map(skill => 
                    `<span class="skill-badge">${skill}</span>`
                ).join('');
            }
        }

        async function closeIDP() {
            const confirmed = await showConfirm(
                '–ó–∞–∫—Ä—ã—Ç—å –ò–ü–†',
                '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —ç—Ç–æ—Ç –ò–ü–†? –û–Ω –∏—Å—á–µ–∑–Ω–µ—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö.',
                {
                    confirmText: '–î–∞, –∑–∞–∫—Ä—ã—Ç—å',
                    cancelText: '–û—Ç–º–µ–Ω–∞',
                    confirmClass: 'btn-danger'
                }
            );
            
            if (!confirmed) {
                return;
            }

            try {
                await apiRequest(`/idps/${idpId}/close`, {
                    method: 'PATCH'
                });

                showSuccess('–ò–ü–† —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç');
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 1000);
            } catch (error) {
                showError(error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        loadKanban();
    </script>
</body>
</html>
