<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ñ–∏–ª—å - –ò–ü–†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css?v=16">
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <span class="navbar-brand">üí´ –°–µ–≥–æ–¥–Ω—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –µ—â–µ –æ–¥–Ω–∞ –∫—Ä—É—Ç–∞—è –∑–∞–¥–∞—á–∞</span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">–î–∞—à–±–æ—Ä–¥</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">–í—ã—Ö–æ–¥</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
        <div class="card mb-4">
            <div class="profile-header">
                <div class="profile-avatar" id="profileAvatar">?</div>
                <h2 class="text-center mb-2" id="profileName">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                <p class="text-center mb-0" id="profileRole"></p>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-end mb-3">
                    <button class="btn btn-primary btn-sm" onclick="openEditModal()">
                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                    </button>
                </div>
                
                <div class="row" id="mentorFields">
                    <div class="col-md-6 mb-3">
                        <strong>Email:</strong>
                        <p class="text-muted" id="profileEmail">-</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</strong>
                        <p class="text-muted" id="mentorPosition">-</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>–ì—Ä–µ–π–¥:</strong>
                        <p class="text-muted" id="mentorGrade">-</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>–°–æ–∑–¥–∞–Ω–æ –ò–ü–†:</strong>
                        <p class="text-muted">
                            <span id="mentorTotalIdps">0</span> –≤—Å–µ–≥–æ / 
                            <span id="mentorCompletedIdps">0</span> –∑–∞–≤–µ—Ä—à–µ–Ω–æ
                        </p>
                    </div>
                </div>
                
                <div class="row" id="menteeFields" style="display: none;">
                    <div class="col-md-6 mb-3">
                        <strong>–§–∞–º–∏–ª–∏—è –∏ –∏–º—è:</strong>
                        <p class="text-muted" id="menteeName">-</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>Email:</strong>
                        <p class="text-muted" id="menteeEmail">-</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</strong>
                        <p class="text-muted" id="menteePosition">-</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>–ì—Ä–µ–π–¥:</strong>
                        <p class="text-muted" id="menteeGrade">-</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞:</strong>
                        <p class="text-muted" id="menteeAccessCode">-</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>–ú–æ–∏ –ò–ü–†:</strong>
                        <p class="text-muted">
                            <span id="menteeTotalIdps">0</span> –≤—Å–µ–≥–æ / 
                            <span id="menteeCompletedIdps">0</span> –∑–∞–≤–µ—Ä—à–µ–Ω–æ
                        </p>
                    </div>
                    <div class="col-md-12 mb-3">
                        <strong>–ú–µ–Ω—Ç–æ—Ä:</strong>
                        <p class="text-muted" id="menteeMentor">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –º–µ–Ω—Ç–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω—Ç–æ—Ä–∞) -->
        <div id="menteeSection" style="display: none;">
            <h3 class="mb-3">–ú–æ–∏ –º–µ–Ω—Ç–∏</h3>
            <div class="card">
                <div class="card-body">
                    <ul class="mentee-list" id="menteeList">
                        <li class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            –ó–∞–≥—Ä—É–∑–∫–∞...
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è -->
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="mb-3">
                            <label for="editFullName" class="form-label">–§–∞–º–∏–ª–∏—è –∏ –∏–º—è *</label>
                            <input type="text" class="form-control" id="editFullName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editEmail" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="editEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPosition" class="form-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                            <input type="text" class="form-control" id="editPosition" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: QA Engineer">
                        </div>
                        <div class="mb-3">
                            <label for="editGrade" class="form-label">–ì—Ä–µ–π–¥</label>
                            <input type="text" class="form-control" id="editGrade" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Middle">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/app.js?v=29"></script>
    <script>
        // currentUser —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω–∞ –≤ app.js
        let isMentor = false;

        async function loadProfile() {
            if (!await checkAuth()) return;

            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ API
                console.log('[DEBUG] Loading user profile from API...');
                currentUser = await apiRequest('/users/me');
                console.log('[DEBUG] User profile loaded:', currentUser);
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–æ–ª—å
                isMentor = currentUser.role === 'mentor';
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                saveUser(currentUser);
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –ò–ü–† –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                const allIdps = await apiRequest('/idps/?include_all=true');
                console.log('[DEBUG] All IDPs loaded:', allIdps.length);
                
                // –ü–æ–¥—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                const totalIdps = allIdps.length;
                const completedIdps = allIdps.filter(idp => idp.status === 'completed').length;
                const idpStats = { total: totalIdps, completed: completedIdps };
                
                console.log('[DEBUG] IDP Stats:', idpStats);
                
                if (allIdps.length === 0) {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –ò–ü–† - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    displayProfile(currentUser, { total: 0, completed: 0 }, null);
                    if (isMentor) {
                        document.getElementById('menteeSection').style.display = 'block';
                        document.getElementById('menteeList').innerHTML = 
                            '<li class="text-center py-3 text-muted">–ù–µ—Ç –º–µ–Ω—Ç–∏</li>';
                    }
                    return;
                }

                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ–Ω—Ç–æ—Ä–µ –¥–ª—è –º–µ–Ω—Ç–∏
                let mentorInfo = null;
                if (!isMentor) {
                    const firstIdp = allIdps[0];
                    if (firstIdp && firstIdp.mentor) {
                        mentorInfo = firstIdp.mentor;
                    }
                }
                
                console.log('[DEBUG] Current user data:', currentUser);
                console.log('[DEBUG] Is mentor:', isMentor);
                console.log('[DEBUG] Mentor info:', mentorInfo);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
                displayProfile(currentUser, idpStats, mentorInfo);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
                if (isMentor) {
                    await loadMentees();
                }
            } catch (error) {
                console.error('[ERROR] loadProfile failed:', error);
                showError(error);
            }
        }
        
        function displayProfile(user, idpStats, mentorInfo = null) {
            console.log('[DEBUG] displayProfile called with:', user, idpStats, mentorInfo);
            
            if (!user) {
                console.error('[ERROR] User is undefined in displayProfile');
                return;
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
            document.getElementById('profileAvatar').textContent = getInitials(user.full_name);
            document.getElementById('profileName').textContent = user.full_name;
            document.getElementById('profileRole').textContent = isMentor ? '–ú–µ–Ω—Ç–æ—Ä' : '–ú–µ–Ω—Ç–∏';
            
            if (isMentor) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—è –¥–ª—è –º–µ–Ω—Ç–æ—Ä–∞
                document.getElementById('mentorFields').style.display = 'flex';
                document.getElementById('menteeFields').style.display = 'none';
                
                document.getElementById('profileEmail').textContent = user.email || '-';
                document.getElementById('mentorPosition').textContent = user.position || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                document.getElementById('mentorGrade').textContent = user.grade || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                document.getElementById('mentorTotalIdps').textContent = idpStats.total || 0;
                document.getElementById('mentorCompletedIdps').textContent = idpStats.completed || 0;
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—è –¥–ª—è –º–µ–Ω—Ç–∏
                document.getElementById('mentorFields').style.display = 'none';
                document.getElementById('menteeFields').style.display = 'flex';
                
                document.getElementById('menteeName').textContent = user.full_name;
                document.getElementById('menteeEmail').textContent = user.email || '-';
                document.getElementById('menteePosition').textContent = user.position || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                document.getElementById('menteeGrade').textContent = user.grade || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                document.getElementById('menteeAccessCode').textContent = user.access_code || '-';
                document.getElementById('menteeTotalIdps').textContent = idpStats.total || 0;
                document.getElementById('menteeCompletedIdps').textContent = idpStats.completed || 0;
                
                if (mentorInfo) {
                    document.getElementById('menteeMentor').textContent = 
                        `${mentorInfo.full_name} (${mentorInfo.email || 'email –Ω–µ —É–∫–∞–∑–∞–Ω'})`;
                } else {
                    document.getElementById('menteeMentor').textContent = '-';
                }
            }
        }

        async function loadMentees() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –º–µ–Ω—Ç–æ—Ä
            if (!isMentor) {
                console.log('[DEBUG] Not a mentor, skipping loadMentees');
                return;
            }
            
            document.getElementById('menteeSection').style.display = 'block';
            
            try {
                console.log('[DEBUG] Loading mentees...');
                const mentees = await apiRequest('/idps/mentees/list');
                console.log('[DEBUG] Mentees:', mentees);
                
                const idps = await apiRequest('/idps/');
                console.log('[DEBUG] IDPs:', idps);
                
                const menteeList = document.getElementById('menteeList');
                
                if (mentees.length === 0) {
                    menteeList.innerHTML = '<li class="text-center py-3 text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ–Ω—Ç–∏</li>';
                    return;
                }

                menteeList.innerHTML = mentees.map((mentee, index) => {
                    const menteeIdp = idps.find(idp => idp.mentee_id === mentee.id);
                    
                    if (!menteeIdp) {
                        console.warn(`–ò–ü–† –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –º–µ–Ω—Ç–∏ ${mentee.full_name}`);
                        return `
                            <li class="mentee-item">
                                <div>
                                    <h6 class="mb-1">${mentee.full_name}</h6>
                                    <small class="text-muted">
                                        –ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞: ${mentee.access_code}<br>
                                        <span class="text-danger">–ò–ü–† –Ω–µ –Ω–∞–π–¥–µ–Ω</span>
                                    </small>
                                </div>
                            </li>
                        `;
                    }
                    
                    return `
                        <li class="mentee-item">
                            <div>
                                <h6 class="mb-1">${mentee.full_name}</h6>
                                <small class="text-muted">
                                    ${mentee.email || ''}<br>
                                    –ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞: ${mentee.access_code}
                                </small>
                            </div>
                            <div>
                                <a href="/kanban/${menteeIdp.id}" class="btn btn-sm btn-primary">
                                    –û—Ç–∫—Ä—ã—Ç—å –ò–ü–†
                                </a>
                            </div>
                        </li>
                    `;
                }).join('');
            } catch (error) {
                showError(error);
            }
        }

        function openEditModal() {
            if (!currentUser) {
                showError({ message: '–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã' });
                return;
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            document.getElementById('editFullName').value = currentUser.full_name || '';
            document.getElementById('editEmail').value = currentUser.email || '';
            document.getElementById('editPosition').value = currentUser.position || '';
            document.getElementById('editGrade').value = currentUser.grade || '';
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            new bootstrap.Modal(document.getElementById('editProfileModal')).show();
        }

        async function saveProfile() {
            console.log('[DEBUG] saveProfile called');
            
            // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ—à–∏–±–æ–∫
            clearAllErrors('editProfileForm');
            
            const fullName = document.getElementById('editFullName').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            const position = document.getElementById('editPosition').value.trim();
            const grade = document.getElementById('editGrade').value.trim();
            
            console.log('[DEBUG] Form values:', { fullName, email, position, grade });
            
            let hasErrors = false;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –§–ò
            if (!validateRequired(fullName)) {
                showFieldError('editFullName', '–§–ò –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
                hasErrors = true;
            } else if (!validateFullName(fullName)) {
                showFieldError('editFullName', '–í–≤–µ–¥–∏—Ç–µ –§–∞–º–∏–ª–∏—é –∏ –ò–º—è');
                hasErrors = true;
            } else {
                showFieldSuccess('editFullName');
            }
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è email
            if (!validateRequired(email)) {
                showFieldError('editEmail', 'Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
                hasErrors = true;
            } else if (!validateEmail(email)) {
                showFieldError('editEmail', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email');
                hasErrors = true;
            } else {
                showFieldSuccess('editEmail');
            }
            
            // –î–æ–ª–∂–Ω–æ—Å—Ç—å –∏ –≥—Ä–µ–π–¥ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã
            if (position) {
                showFieldSuccess('editPosition');
            }
            if (grade) {
                showFieldSuccess('editGrade');
            }
            
            if (hasErrors) return;
            
            try {
                console.log('[DEBUG] Sending PATCH request...');
                
                const updatedUser = await apiRequest('/users/me', {
                    method: 'PATCH',
                    body: JSON.stringify({
                        full_name: fullName,
                        email: email,
                        position: position || null,
                        grade: grade || null
                    })
                });
                
                console.log('[DEBUG] Profile updated successfully:', updatedUser);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º role –∏ id
                const newUserData = {
                    id: currentUser.id,
                    full_name: updatedUser.full_name,
                    email: updatedUser.email,
                    role: updatedUser.role || currentUser.role,
                    position: updatedUser.position,
                    grade: updatedUser.grade,
                    access_code: updatedUser.access_code
                };
                
                console.log('[DEBUG] New user data:', newUserData);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                saveUser(newUserData);
                currentUser = newUserData;
                
                console.log('[DEBUG] User saved to localStorage');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modalElement = document.getElementById('editProfileModal');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }
                
                console.log('[DEBUG] Modal closed');
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
                await loadProfile();
                
                console.log('[DEBUG] Profile reloaded');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                showSuccess('–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
            } catch (error) {
                console.error('[ERROR] Save profile failed:', error);
                showError({ 
                    message: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') 
                });
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫—É –æ—à–∏–±–æ–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
        addInputValidationListeners('editProfileForm');
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        loadProfile();
    </script>
</body>
</html>


