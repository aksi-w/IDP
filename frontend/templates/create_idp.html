<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–∑–¥–∞—Ç—å –ò–ü–† - –ò–ü–†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css?v=16">
    <style>
        .template-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .template-card:hover {
            background-color: #f8f9fa;
            border-color: #0d6efd;
        }
        .template-card.selected {
            background-color: #e7f1ff;
            border-color: #0d6efd;
            border-width: 2px;
        }
        .level-badge {
            font-size: 0.75rem;
            padding: 3px 8px;
        }
        .category-section {
            margin-bottom: 20px;
        }
        .selected-count {
            background-color: #0d6efd;
            color: white;
            border-radius: 50%;
            padding: 2px 8px;
            font-size: 0.85rem;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <span class="navbar-brand">üí´ –°–µ–≥–æ–¥–Ω—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –µ—â–µ –æ–¥–Ω–∞ –∫—Ä—É—Ç–∞—è –∑–∞–¥–∞—á–∞</span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">–î–∞—à–±–æ—Ä–¥</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">–í—ã—Ö–æ–¥</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- –®–∞–≥ 1: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ–Ω—Ç–∏ -->
        <div class="row" id="step1">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-body p-4">
                        <h2 class="mb-4">–®–∞–≥ 1: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ</h2>
                        
                        <form id="menteeInfoForm">
                            <div class="mb-3">
                                <label for="menteeName" class="form-label">–§–∞–º–∏–ª–∏—è –∏ –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–º–µ–Ω—Ç–∏) *</label>
                                <input type="text" class="form-control" id="menteeName" 
                                       placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω" required>
                            </div>

                            <div class="mb-3">
                                <label for="menteeEmail" class="form-label">Email —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ *</label>
                                <input type="email" class="form-control" id="menteeEmail" 
                                       placeholder="ivanov@example.com" required>
                            </div>

                            <div class="mb-3">
                                <label for="menteePosition" class="form-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                                <input type="text" class="form-control" id="menteePosition" 
                                       placeholder="QA Engineer">
                            </div>

                            <div class="mb-4">
                                <label for="menteeGrade" class="form-label">–ì—Ä–µ–π–¥</label>
                                <input type="text" class="form-control" id="menteeGrade" 
                                       placeholder="Middle">
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    –î–∞–ª–µ–µ: –í—ã–±—Ä–∞—Ç—å –∑–∞–¥–∞—á–∏
                                </button>
                                <a href="/dashboard" class="btn btn-secondary">
                                    –û—Ç–º–µ–Ω–∞
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- –®–∞–≥ 2: –í—ã–±–æ—Ä –∑–∞–¥–∞—á –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤ -->
        <div class="row d-none" id="step2">
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="mb-0">
                                –®–∞–≥ 2: –í—ã–±–æ—Ä –∑–∞–¥–∞—á –¥–ª—è –ò–ü–†
                                <span class="selected-count" id="selectedCount">0</span>
                            </h2>
                            <button class="btn btn-link" onclick="showStep1()">
                                ‚Üê –ù–∞–∑–∞–¥
                            </button>
                        </div>

                        <!-- –ü–æ–∏—Å–∫ -->
                        <div class="mb-4">
                            <div class="input-group">
                                <input type="text" class="form-control" id="searchInput" 
                                       placeholder="–ü–æ–∏—Å–∫ –∑–∞–¥–∞—á –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –æ–ø–∏—Å–∞–Ω–∏—é...">
                                <button class="btn btn-outline-secondary" onclick="searchTemplates()">
                                    üîç –ü–æ–∏—Å–∫
                                </button>
                            </div>
                        </div>

                        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (–∞–∫–∫–æ—Ä–¥–µ–æ–Ω) -->
                        <div class="accordion" id="categoriesAccordion">
                            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                        <div class="mt-4 d-flex gap-2">
                            <button class="btn btn-success" onclick="createIdpWithTasks()">
                                –°–æ–∑–¥–∞—Ç—å –ò–ü–† (<span id="selectedCount2">0</span> –∑–∞–¥–∞—á)
                            </button>
                            <button class="btn btn-outline-primary" onclick="skipTaskSelection()">
                                –°–æ–∑–¥–∞—Ç—å –±–µ–∑ –∑–∞–¥–∞—á
                            </button>
                            <button class="btn btn-secondary" onclick="showStep1()">
                                –ù–∞–∑–∞–¥
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è -->
    <div class="modal fade" id="successModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">–ò–ü–† —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!</h5>
                </div>
                <div class="modal-body">
                    <p>–ò–ü–† –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ <strong id="createdMenteeName"></strong> —Å–æ–∑–¥–∞–Ω.</p>
                    <p id="tasksAddedInfo" class="text-muted"></p>
                    <div class="alert alert-warning">
                        <strong>–í–∞–∂–Ω–æ!</strong>
                        <p class="mb-2">–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –º–µ–Ω—Ç–∏:</p>
                        <h4 class="text-center mb-2">
                            <code id="accessCode" style="font-size: 1.5rem;"></code>
                        </h4>
                        <p class="mb-0">
                            <small>–ü–µ—Ä–µ–¥–∞–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É. –û–Ω –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É.</small>
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="goToDashboard()">
                        –ü–µ—Ä–µ–π—Ç–∏ –∫ –¥–∞—à–±–æ—Ä–¥—É
                    </button>
                    <button type="button" class="btn btn-success" onclick="goToKanban()">
                        –û—Ç–∫—Ä—ã—Ç—å –∫–∞–Ω–±–∞–Ω –¥–æ—Å–∫—É
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/app.js?v=29"></script>
    <script>
        let createdIdpId = null;
        let selectedTemplates = new Set();
        let allCategories = [];

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –º–µ–Ω—Ç–æ—Ä–∞
        async function checkMentorAccess() {
            if (!await checkAuth()) return;

            try {
                const idps = await apiRequest('/idps/');
                if (idps.length > 0) {
                    const isMentor = idps[0].mentor_id === idps[0].mentor.id;
                    if (!isMentor) {
                        showError({ message: '–¢–æ–ª—å–∫–æ –º–µ–Ω—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ò–ü–†' });
                        setTimeout(() => {
                            window.location.href = '/dashboard';
                        }, 1000);
                    }
                }
            } catch (error) {
                showError(error);
            }
        }

        // –®–∞–≥ 1: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ–Ω—Ç–∏ –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ –≤—ã–±–æ—Ä—É –∑–∞–¥–∞—á
        document.getElementById('menteeInfoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ—à–∏–±–æ–∫
            clearAllErrors('menteeInfoForm');
            
            const menteeName = document.getElementById('menteeName').value.trim();
            const menteeEmail = document.getElementById('menteeEmail').value.trim();
            
            let hasErrors = false;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –§–ò–û (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
            if (!validateRequired(menteeName)) {
                showFieldError('menteeName', '–§–∞–º–∏–ª–∏—è –∏ –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã');
                hasErrors = true;
            } else if (!validateFullName(menteeName)) {
                showFieldError('menteeName', '–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é –∏ –∏–º—è');
                hasErrors = true;
            } else {
                showFieldSuccess('menteeName');
            }
            
            if (!validateRequired(menteeEmail)) {
                showFieldError('menteeEmail', 'Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
                hasErrors = true;
            } else if (!validateEmail(menteeEmail)) {
                showFieldError('menteeEmail', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email');
                hasErrors = true;
            } else {
                showFieldSuccess('menteeEmail');
            }
            
            if (hasErrors) return;
            
            showStep2();
            await loadCategories();
        });

        function showStep1() {
            document.getElementById('step1').classList.remove('d-none');
            document.getElementById('step2').classList.add('d-none');
        }

        function showStep2() {
            document.getElementById('step1').classList.add('d-none');
            document.getElementById('step2').classList.remove('d-none');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        async function loadCategories() {
            try {
                const categories = await apiRequest('/templates/categories');
                allCategories = categories;
                renderCategories(categories);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
                showError(error);
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        function renderCategories(categories) {
            const accordion = document.getElementById('categoriesAccordion');
            accordion.innerHTML = '';

            categories.forEach((cat, index) => {
                const collapseId = `collapse${index}`;
                const item = document.createElement('div');
                item.className = 'accordion-item';
                item.innerHTML = `
                    <h2 class="accordion-header">
                        <button class="accordion-button ${index !== 0 ? 'collapsed' : ''}" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                            ${cat.category} <small class="text-muted ms-2">(${cat.count} –∑–∞–¥–∞—á)</small>
                        </button>
                    </h2>
                    <div id="${collapseId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                         data-bs-parent="#categoriesAccordion">
                        <div class="accordion-body" id="templates${index}">
                            <div class="text-center text-muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        </div>
                    </div>
                `;
                accordion.appendChild(item);

                // –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤ –ø—Ä–∏ —Ä–∞—Å–∫—Ä—ã—Ç–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                document.getElementById(collapseId).addEventListener('shown.bs.collapse', async () => {
                    await loadTemplatesForCategory(cat.category, `templates${index}`);
                });
            });

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å—Ä–∞–∑—É
            if (categories.length > 0) {
                loadTemplatesForCategory(categories[0].category, 'templates0');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        async function loadTemplatesForCategory(category, containerId) {
            try {
                const templates = await apiRequest(`/templates/by-category/${encodeURIComponent(category)}`);
                const container = document.getElementById(containerId);
                
                if (templates.length === 0) {
                    container.innerHTML = '<p class="text-muted">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞—á</p>';
                    return;
                }

                container.innerHTML = templates.map(t => `
                    <div class="template-card ${selectedTemplates.has(t.id) ? 'selected' : ''}" 
                         onclick="toggleTemplate(${t.id})">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    ${t.skill_name}
                                    ${t.level ? `<span class="badge level-badge bg-info">–£—Ä–æ–≤–µ–Ω—å ${t.level}</span>` : ''}
                                    <span class="badge bg-secondary level-badge">${t.source === 'kb_tasks' ? '–ë–ó' : 'Hard Skills'}</span>
                                </h6>
                                <p class="mb-1 text-muted small">${t.goal || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è —Ü–µ–ª–∏'}</p>
                                ${t.duration_weeks ? `<small class="text-muted">‚è± ${t.duration_weeks} –Ω–µ–¥–µ–ª—å</small>` : ''}
                            </div>
                            <div>
                                <input type="checkbox" class="form-check-input" 
                                       ${selectedTemplates.has(t.id) ? 'checked' : ''} 
                                       onclick="event.stopPropagation()">
                            </div>
                        </div>
                        ${t.description ? `
                            <details class="mt-2">
                                <summary class="small text-primary" style="cursor: pointer;">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</summary>
                                <p class="small mt-2 mb-0">${t.description.substring(0, 300)}${t.description.length > 300 ? '...' : ''}</p>
                            </details>
                        ` : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤:', error);
                document.getElementById(containerId).innerHTML = '<p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —à–∞–±–ª–æ–Ω–∞
        function toggleTemplate(templateId) {
            if (selectedTemplates.has(templateId)) {
                selectedTemplates.delete(templateId);
            } else {
                selectedTemplates.add(templateId);
            }
            updateSelectedCount();
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ
            const card = event.currentTarget;
            card.classList.toggle('selected');
            const checkbox = card.querySelector('input[type="checkbox"]');
            checkbox.checked = selectedTemplates.has(templateId);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
        function updateSelectedCount() {
            const count = selectedTemplates.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('selectedCount2').textContent = count;
        }

        // –ü–æ–∏—Å–∫ —à–∞–±–ª–æ–Ω–æ–≤
        async function searchTemplates() {
            const query = document.getElementById('searchInput').value;
            if (!query.trim()) {
                await loadCategories();
                return;
            }

            try {
                const results = await apiRequest(`/templates/search?q=${encodeURIComponent(query)}`);
                const accordion = document.getElementById('categoriesAccordion');
                
                if (results.length === 0) {
                    accordion.innerHTML = '<p class="text-center text-muted mt-4">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                    return;
                }

                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                const grouped = results.reduce((acc, t) => {
                    if (!acc[t.category]) acc[t.category] = [];
                    acc[t.category].push(t);
                    return acc;
                }, {});

                renderCategories(Object.keys(grouped).map(cat => ({
                    category: cat,
                    count: grouped[cat].length
                })));
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ò–ü–† —Å –∑–∞–¥–∞—á–∞–º–∏
        async function createIdpWithTasks() {
            const menteeName = document.getElementById('menteeName').value;
            const menteeEmail = document.getElementById('menteeEmail').value;
            const menteePosition = document.getElementById('menteePosition').value;
            const menteeGrade = document.getElementById('menteeGrade').value;

            if (selectedTemplates.size === 0) {
                const confirmed = await showConfirm(
                    '–°–æ–∑–¥–∞—Ç—å –ø—É—Å—Ç–æ–π –ò–ü–†',
                    '–í—ã –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –Ω–∏ –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–∏. –°–æ–∑–¥–∞—Ç—å –ø—É—Å—Ç–æ–π –ò–ü–† –±–µ–∑ –∑–∞–¥–∞—á?',
                    {
                        confirmText: '–î–∞, —Å–æ–∑–¥–∞—Ç—å',
                        cancelText: '–û—Ç–º–µ–Ω–∞',
                        confirmClass: 'btn-warning'
                    }
                );
                
                if (!confirmed) {
                    return;
                }
            }

            try {
                console.log('[DEBUG] Creating IDP...');
                
                // –°–æ–∑–¥–∞–µ–º –ò–ü–†
                const idp = await apiRequest('/idps/', {
                    method: 'POST',
                    body: JSON.stringify({
                        mentee_full_name: menteeName,
                        mentee_email: menteeEmail || null,
                        mentee_position: menteePosition || null,
                        mentee_grade: menteeGrade || null
                    })
                });

                console.log('[DEBUG] IDP created:', idp);
                createdIdpId = idp.id;

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á–∏ –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤
                if (selectedTemplates.size > 0) {
                    console.log('[DEBUG] Adding tasks from templates...');
                    await addTasksFromTemplates(idp.id);
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                document.getElementById('createdMenteeName').textContent = menteeName;
                document.getElementById('accessCode').textContent = idp.mentee.access_code;
                document.getElementById('tasksAddedInfo').textContent = 
                    selectedTemplates.size > 0 ? `–î–æ–±–∞–≤–ª–µ–Ω–æ –∑–∞–¥–∞—á: ${selectedTemplates.size}` : '';
                
                console.log('[DEBUG] Opening success modal');
                new bootstrap.Modal(document.getElementById('successModal')).show();
            } catch (error) {
                console.error('[ERROR] Failed to create IDP:', error);
                
                // –ë–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                let errorMessage = error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ò–ü–†';
                
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–∫—Ç–∏–≤–Ω–æ–º –ò–ü–†
                if (errorMessage.includes('—É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –ò–ü–†')) {
                    showWarning(errorMessage);
                } else {
                    showError(error);
                }
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤
        async function addTasksFromTemplates(idpId) {
            const templateIds = Array.from(selectedTemplates);
            
            for (const templateId of templateIds) {
                try {
                    const template = await apiRequest(`/templates/${templateId}`);
                    
                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º deadline
                    let deadline = null;
                    if (template.duration_weeks) {
                        const date = new Date();
                        date.setDate(date.getDate() + (template.duration_weeks * 7));
                        deadline = date.toISOString();
                    }

                    await apiRequest('/tasks/', {
                        method: 'POST',
                        body: JSON.stringify({
                            idp_id: idpId,
                            title: `${template.skill_name} (–£—Ä–æ–≤–µ–Ω—å ${template.level || 1})`,
                            description: `${template.goal}\n\n${template.description}\n\n–ö—Ä–∏—Ç–µ—Ä–∏–∏:\n${template.criteria}`,
                            priority: 'medium',
                            deadline: deadline,
                            linked_skills: {
                                category: template.category,
                                skill: template.skill_name,
                                level: template.level
                            }
                        })
                    });
                } catch (error) {
                    console.error(`–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ ${templateId}:`, error);
                }
            }
        }

        // –°–æ–∑–¥–∞—Ç—å –±–µ–∑ –∑–∞–¥–∞—á
        async function skipTaskSelection() {
            await createIdpWithTasks();
        }

        function goToDashboard() {
            window.location.href = '/dashboard';
        }

        function goToKanban() {
            window.location.href = `/kanban/${createdIdpId}`;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫—É –æ—à–∏–±–æ–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
        addInputValidationListeners('menteeInfoForm');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        checkMentorAccess();
    </script>
</body>
</html>
